version: '3.8'

services:
  # Backend API server
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.backend
    container_name: simple-cdn-backend
    restart: unless-stopped
    environment:
      # Admin credentials
      ADMIN_USERNAME: ${ADMIN_USERNAME}
      ADMIN_PASSWORD_HASH: ${ADMIN_PASSWORD_HASH}

      # Storage
      STORAGE_TYPE: ${STORAGE_TYPE:-local}
      STORAGE_ROOT: /app/storage

      # S3 (if using S3 storage)
      S3_ENDPOINT: ${S3_ENDPOINT:-}
      S3_BUCKET: ${S3_BUCKET:-}
      S3_REGION: ${S3_REGION:-us-east-1}
      S3_ACCESS_KEY: ${S3_ACCESS_KEY:-}
      S3_SECRET_KEY: ${S3_SECRET_KEY:-}

      # Application
      BASE_URL: ${BASE_URL:-http://localhost:8080}
      PORT: 3000
      NODE_ENV: ${NODE_ENV:-production}

      # Features
      READONLY: ${READONLY:-false}
      ENABLE_METRICS: ${ENABLE_METRICS:-true}

      # Security
      SESSION_SECRET: ${SESSION_SECRET}
      MAX_UPLOAD_SIZE: ${MAX_UPLOAD_SIZE:-10485760}
      RATE_LIMIT_REQUESTS: ${RATE_LIMIT_REQUESTS:-100}
      RATE_LIMIT_WINDOW: ${RATE_LIMIT_WINDOW:-60000}

      # Thumbnails
      THUMBNAIL_SIZE: ${THUMBNAIL_SIZE:-128}
      THUMBNAIL_QUALITY: ${THUMBNAIL_QUALITY:-85}

      # Logging
      LOG_LEVEL: ${LOG_LEVEL:-info}
    volumes:
      # Persistent storage for uploaded files
      - cdn-storage:/app/storage
    networks:
      - cdn-network
    healthcheck:
      test: ["CMD", "bun", "run", "--eval", "fetch('http://localhost:3000/healthz').then(r => r.ok ? process.exit(0) : process.exit(1)).catch(() => process.exit(1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  # Reverse proxy (Caddy)
  proxy:
    image: caddy:2-alpine
    container_name: simple-cdn-proxy
    restart: unless-stopped
    ports:
      # HTTP (redirects to HTTPS in production)
      - "${HTTP_PORT:-80}:80"
      # HTTPS (production)
      - "${HTTPS_PORT:-443}:443"
      # Local development
      - "8080:8080"
    volumes:
      - ./docker/Caddyfile:/etc/caddy/Caddyfile:ro
      - ./frontend/dist:/var/www/html:ro
      - caddy-data:/data
      - caddy-config:/config
    depends_on:
      - backend
    networks:
      - cdn-network

networks:
  cdn-network:
    driver: bridge

volumes:
  cdn-storage:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
